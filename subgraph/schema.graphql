enum Role {
  Public
  Developer
  Auditor
}

enum Standard {
  GoldStandard
  VCS
  Shariah
}

enum ProposalStatus {
  PendingReview
  ChangesRequested
  Rejected
  Approved
}

enum ProjectStatus {
  None
  InProgress
  ProofSubmitted
  AuditRejected
  Finalized
}

enum ReviewAction {
  Approve
  RequestChanges
  Reject
}

enum ListingStatus {
  Active
  Cancelled
  Filled
}

type User @entity {
  id: ID!
  role: Role!
  documentCid: String
  proofOfAddressCid: String
  certificationCid: String
  proposals: [Proposal!]! @derivedFrom(field: "developer")
  reviews: [ProposalReview!]! @derivedFrom(field: "auditor")
  proofs: [Proof!]! @derivedFrom(field: "developer")
  creditBalances: [CreditBalance!]! @derivedFrom(field: "user")
}

type Proposal @entity {
  id: ID!
  developer: User!
  name: String!
  description: String!
  location: String!
  estimatedCredits: BigInt!
  vintage: Int!
  methodology: String!
  projectPlanCID: String!
  eiaCID: String!
  otherDocsCID: String!
  metadataCID: String!
  submittedAt: Timestamp!
  standard: Standard!
  status: ProposalStatus!
  reviews: [ProposalReview!]! @derivedFrom(field: "proposal")
  project: Project @derivedFrom(field: "proposal")
}

type ProposalReview @entity {
  id: ID!
  proposal: Proposal!
  auditor: User!
  action: ReviewAction!
  commentCID: String
  timestamp: Timestamp!
}

type Project @entity {
  id: ID! # projectId
  proposal: Proposal!
  developer: User!
  status: ProjectStatus!
  proofs: [Proof!]! @derivedFrom(field: "project")
  credit: CreditBatch @derivedFrom(field: "project")
  createdAt: Timestamp!
}

type Proof @entity {
  id: ID!
  project: Project!
  developer: User!
  proofCID: String!
  audits: [ProofAudit!]! @derivedFrom(field: "proof")
  submittedAt: Timestamp!
}

type ProofAudit @entity {
  id: ID!
  proof: Proof!
  auditor: User!
  action: ReviewAction!
  commentCID: String
  timestamp: Timestamp!
}

# CreditBatch (ERC1155 issuances)
type CreditBatch @entity {
  id: ID! # tokenId
  project: Project
  developer: User
  amount: BigInt!
  issuedAt: Timestamp!
  tokenURI: String!
  retiredAmount: BigInt! # total retired from this batch
  creditBalances: [CreditBalance!]! @derivedFrom(field: "batch")
}

type CreditBalance @entity {
  id: ID!
  user: User!
  batch: CreditBatch!
  balance: BigInt!
}

type MarketplaceListing @entity {
  id: ID! # listingId
  seller: User!
  token: CreditBatch! # the CreditBatch being sold
  amount: BigInt!
  remaining: BigInt!
  pricePerUnit: BigInt!
  startTime: Timestamp
  endTime: Timestamp
  status: ListingStatus!
  createdAt: Timestamp!
  updatedAt: Timestamp!
  purchases: [MarketplacePurchase!]! @derivedFrom(field: "listing")
}

# Transactions / Events for Statistics

type CreditsIssued @entity(timeseries: true) {
  id: Int8!
  internal_id: BigInt! # uint256
  developer: User! # address
  amount: BigInt! # uint256
  tokenId: BigInt! # uint256
  tokenURI: String! # string
  blockNumber: BigInt!
  timestamp: Timestamp!
  transactionHash: Bytes!
}

type ProjectProposed @entity(timeseries: true) {
  id: Int8!
  internal_id: BigInt! # uint256
  developer: User! # address
  meta_name: String! # string
  meta_description: String! # string
  meta_location: String! # string
  meta_estimatedCredits: BigInt! # uint256
  meta_standard: Standard! # uint8
  meta_vintage: Int! # uint16
  meta_methodology: String! # string
  meta_projectPlanCID: String! # string
  meta_eiaCID: String! # string
  meta_otherDocsCID: String! # string
  meta_metadataCID: String! # string
  blockNumber: BigInt!
  timestamp: Timestamp!
  transactionHash: Bytes!
}

type ProposalReviewed @entity(timeseries: true) {
  id: Int8!
  internal_id: BigInt! # uint256
  auditor: User! # address
  action: Int! # uint8
  commentCID: String! # string
  blockNumber: BigInt!
  timestamp: Timestamp!
  transactionHash: Bytes!
}

type ProofAudited @entity(timeseries: true) {
  id: Int8!
  internal_id: BigInt! # uint256
  auditor: User! # address
  action: BigInt! # uint8
  commentCID: String! # string
  blockNumber: BigInt!
  timestamp: Timestamp!
  transactionHash: Bytes!
}

type CreditsRetired @entity(timeseries: true) {
  id: Int8!
  holder: User! # who retired
  tokenId: BigInt! # which batch
  amount: BigInt! # retired amount
  retirementCID: String
  blockNumber: BigInt!
  timestamp: Timestamp!
  transactionHash: Bytes!
}

type Transaction @entity(timeseries: true) {
  id: Int8!
  from: Bytes! # address
  to: Bytes! # address
  tokenId: BigInt! # uint256
  value: BigInt! # uint256
  blockNumber: BigInt!
  timestamp: Timestamp!
  transactionHash: Bytes!
}

type MarketplacePurchase @entity(timeseries: true) {
  id: Int8!
  listing: MarketplaceListing!
  buyer: User!
  quantity: BigInt!
  totalPaid: BigInt!
  feePaid: BigInt!
  blockNumber: BigInt!
  timestamp: Timestamp!
  transactionHash: Bytes!
}

type Listed @entity(timeseries: true) {
  id: Int8!
  internal_id: BigInt! # uint256
  seller: Bytes! # address
  tokenId: BigInt! # uint256
  amount: BigInt! # uint256
  pricePerUnit: BigInt! # uint256
  startTime: BigInt! # uint64
  endTime: BigInt! # uint64
  blockNumber: BigInt!
  timestamp: Timestamp!
  transactionHash: Bytes!
}

type DailyProjectStats
  @aggregation(intervals: ["day"], source: "ProjectProposed") {
  id: Int8!
  timestamp: Timestamp!
  total: BigInt! @aggregate(fn: "count")
}

type DailyProofStats @aggregation(intervals: ["day"], source: "ProofAudited") {
  id: Int8!
  timestamp: Timestamp!

  approvals: BigInt!
    @aggregate(fn: "count", arg: "case when action = 0 then 1 else null end")

  rejections: BigInt!
    @aggregate(fn: "count", arg: "case when action = 2 then 1 else null end")
}

type DailyReviewStats
  @aggregation(intervals: ["day"], source: "ProposalReviewed") {
  id: Int8!
  timestamp: Timestamp!
  count: BigInt! @aggregate(fn: "count")
  approvals: BigInt!
    @aggregate(fn: "count", arg: "case when action = 0 then 1 else null end")

  rejections: BigInt!
    @aggregate(fn: "count", arg: "case when action = 2 then 1 else null end")
}

type DailyCreditStats
  @aggregation(intervals: ["day"], source: "CreditsIssued") {
  id: Int8!
  timestamp: Timestamp!
  total: BigInt! @aggregate(fn: "sum", arg: "amount")
}

type DailyRetirementStats
  @aggregation(intervals: ["day"], source: "CreditsRetired") {
  id: Int8!
  timestamp: Timestamp!
  total: BigInt! @aggregate(fn: "sum", arg: "amount")
  count: BigInt! @aggregate(fn: "count")
}

type DailyTransactionStats
  @aggregation(intervals: ["day"], source: "Transaction") {
  id: Int8!
  timestamp: Timestamp!
  total: BigInt! @aggregate(fn: "sum", arg: "value")
  count: BigInt! @aggregate(fn: "count")
}

type DailyMarketplaceStats
  @aggregation(intervals: ["day"], source: "MarketplacePurchase") {
  id: Int8!
  timestamp: Timestamp!

  dailyVolume: BigInt! @aggregate(fn: "sum", arg: "totalPaid")
  dailyFees: BigInt! @aggregate(fn: "sum", arg: "feePaid")
  dailyPurchases: BigInt! @aggregate(fn: "count")
}

type DailyMarketplaceListingStats
  @aggregation(intervals: ["day"], source: "Listed") {
  id: Int8!
  timestamp: Timestamp!
  dailyListings: BigInt! @aggregate(fn: "count")
}
